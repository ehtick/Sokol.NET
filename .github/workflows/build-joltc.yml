name: Build JoltC Libraries

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:  # Allow manual triggering

# Required permissions for private repositories
permissions:
  contents: write  # Allow workflow to push commits back to repository

jobs:
  # Check if joltc submodule or source files have changed
  check-changes:
    name: Check for joltc changes
    runs-on: ubuntu-latest
    outputs:
      should_build: ${{ steps.check_sources.outputs.changed }}
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 2
        submodules: recursive
    
    - name: Check for source changes
      id: check_sources
      run: |
        SHOULD_BUILD=false
        
        # Check if this is a manual workflow dispatch - ALWAYS BUILD
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          echo "ğŸ”¨ Manual workflow dispatch - FORCING BUILD"
          SHOULD_BUILD=true
        # Check if this is the first commit
        elif ! git rev-parse HEAD~1 >/dev/null 2>&1; then
          echo "First commit - building all libraries"
          SHOULD_BUILD=true
        else
          # Get changed files
          CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD)
          
          echo "Changed files in this commit:"
          echo "$CHANGED_FILES"
          
          # Check if joltc submodule was updated
          if echo "$CHANGED_FILES" | grep -q "^ext/joltc$"; then
            echo "joltc submodule updated"
            SHOULD_BUILD=true
          fi
          
          # Check if joltc source files or build scripts changed
          while IFS= read -r file; do
            if [[ "$file" == ext/joltc/src/* ]] || \
               [[ "$file" == ext/joltc/include/* ]] || \
               [[ "$file" == ext/joltc/CMakeLists.txt ]] || \
               [[ "$file" == ext/joltc/scripts/* ]] || \
               [[ "$file" == .github/workflows/build-joltc.yml ]]; then
              echo "Found joltc source change: $file"
              SHOULD_BUILD=true
              break
            fi
          done <<< "$CHANGED_FILES"
        fi
        
        if [ "$SHOULD_BUILD" = true ]; then
          echo "changed=true" >> $GITHUB_OUTPUT
          echo "âœ“ Will build joltc libraries"
        else
          echo "changed=false" >> $GITHUB_OUTPUT
          echo "âœ“ No changes affecting joltc libraries - skipping build"
        fi

  build-windows:
    name: Build Windows (x64)
    runs-on: windows-latest
    needs: check-changes
    if: needs.check-changes.outputs.should_build == 'true'
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: Setup CMake
      uses: lukka/get-cmake@latest
    
    - name: Build Release
      shell: pwsh
      run: |
        cd ext/joltc/scripts
        .\build-joltc-windows.ps1
    
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: windows-x64
        path: ext/joltc/libs/windows/**/*
        retention-days: 30

  build-macos:
    name: Build macOS (${{ matrix.arch }})
    runs-on: macos-latest
    needs: check-changes
    if: needs.check-changes.outputs.should_build == 'true'
    strategy:
      matrix:
        arch: [arm64, x86_64]
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: Setup CMake
      uses: lukka/get-cmake@latest
    
    - name: Build Release
      run: |
        cd ext/joltc/scripts
        chmod +x build-joltc-macos.sh
        ./build-joltc-macos.sh
    
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: macos-${{ matrix.arch }}
        path: ext/joltc/libs/macos/**/*
        retention-days: 30

  build-linux:
    name: Build Linux (X64)
    runs-on: ubuntu-22.04
    needs: check-changes
    if: needs.check-changes.outputs.should_build == 'true'
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: Setup CMake
      uses: lukka/get-cmake@latest
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential cmake
    
    - name: Build Release
      run: |
        cd ext/joltc/scripts
        chmod +x build-joltc-linux.sh
        ./build-joltc-linux.sh
    
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: linux-X64
        path: ext/joltc/libs/linux/**/*
        retention-days: 30

  build-web:
    name: Build Web (Emscripten)
    runs-on: ubuntu-latest
    needs: check-changes
    if: needs.check-changes.outputs.should_build == 'true'
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: Setup Emscripten
      uses: mymindstorm/setup-emsdk@v14
      with:
        version: '3.1.34'
    
    - name: Build Release
      run: |
        cd ext/joltc/scripts
        chmod +x build-joltc-web.sh
        ./build-joltc-web.sh
    
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: emscripten-x86
        path: ext/joltc/libs/emscripten/**/*
        retention-days: 30

  build-android:
    name: Build Android (All ABIs)
    runs-on: ubuntu-latest
    needs: check-changes
    if: needs.check-changes.outputs.should_build == 'true'
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: Setup Android SDK
      uses: android-actions/setup-android@v3
    
    - name: Install Android NDK
      run: |
        echo "Installing Android NDK..."
        sdkmanager --install "ndk;27.2.12479018"
        echo "ANDROID_NDK_HOME=$ANDROID_SDK_ROOT/ndk/27.2.12479018" >> $GITHUB_ENV
        echo "ANDROID_NDK_ROOT=$ANDROID_SDK_ROOT/ndk/27.2.12479018" >> $GITHUB_ENV
    
    - name: Build Release (All ABIs)
      run: |
        cd ext/joltc/scripts
        chmod +x build-joltc-android-all.sh
        ./build-joltc-android-all.sh
    
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: android-all
        path: ext/joltc/libs/android/**/*
        retention-days: 30

  build-ios:
    name: Build iOS (arm64)
    runs-on: macos-latest
    needs: check-changes
    if: needs.check-changes.outputs.should_build == 'true'
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: Setup CMake
      uses: lukka/get-cmake@latest
    
    - name: Build Release
      run: |
        cd ext/joltc/scripts
        chmod +x build-joltc-ios.sh
        ./build-joltc-ios.sh
    
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ios-arm64
        path: ext/joltc/libs/ios/**/*
        retention-days: 30

  # Combine all artifacts
  combine-artifacts:
    name: Combine All JoltC Libraries
    needs: [check-changes, build-windows, build-macos, build-linux, build-web, build-android, build-ios]
    runs-on: ubuntu-latest
    if: |
      always() &&
      needs.check-changes.outputs.should_build == 'true' &&
      (needs.build-windows.result == 'success' || needs.build-windows.result == 'skipped') &&
      (needs.build-macos.result == 'success' || needs.build-macos.result == 'skipped') &&
      (needs.build-linux.result == 'success' || needs.build-linux.result == 'skipped') &&
      (needs.build-web.result == 'success' || needs.build-web.result == 'skipped') &&
      (needs.build-android.result == 'success' || needs.build-android.result == 'skipped') &&
      (needs.build-ios.result == 'success' || needs.build-ios.result == 'skipped')
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts
    
    - name: Reorganize artifacts
      run: |
        # Create final structure in ext/joltc/libs/
        mkdir -p combined-libs/windows/x64/release
        mkdir -p combined-libs/macos/release
        mkdir -p combined-libs/linux/X64/release
        mkdir -p combined-libs/emscripten/x86/release
        mkdir -p combined-libs/android
        mkdir -p combined-libs/ios/release
        
        # Copy Windows artifacts
        if [ -d "artifacts/windows-x64" ]; then
          cp -r artifacts/windows-x64/* combined-libs/windows/ || true
        fi
        
        # Copy macOS artifacts (both arm64 and x86_64 go to same directory for universal build)
        if [ -d "artifacts/macos-arm64" ]; then
          cp -r artifacts/macos-arm64/* combined-libs/macos/ || true
        fi
        if [ -d "artifacts/macos-x86_64" ]; then
          cp -r artifacts/macos-x86_64/* combined-libs/macos/ || true
        fi
        
        # Copy Linux artifacts
        if [ -d "artifacts/linux-X64" ]; then
          cp -r artifacts/linux-X64/* combined-libs/linux/ || true
        fi
        
        # Copy Web artifacts
        if [ -d "artifacts/emscripten-x86" ]; then
          cp -r artifacts/emscripten-x86/* combined-libs/emscripten/ || true
        fi
        
        # Copy Android artifacts (all ABIs)
        if [ -d "artifacts/android-all" ]; then
          cp -r artifacts/android-all/* combined-libs/android/ || true
        fi
        
        # Copy iOS artifacts
        if [ -d "artifacts/ios-arm64" ]; then
          cp -r artifacts/ios-arm64/* combined-libs/ios/ || true
        fi
        
        # Show final structure
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "ğŸ“¦ Final artifact structure:"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        find combined-libs -type f | sort
    
    - name: Upload combined artifacts
      uses: actions/upload-artifact@v4
      with:
        name: joltc-libraries-all-platforms
        path: combined-libs/**/*
        retention-days: 90
    
    - name: Commit libraries to repository
      if: github.ref == 'refs/heads/main' && github.event_name == 'push'
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "ğŸ“ Checking git status before staging..."
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        git status ext/joltc/libs/ || echo "ext/joltc/libs/ doesn't exist yet"
        
        # Remove old libraries
        rm -rf ext/joltc/libs/
        
        # Copy new joltc libraries
        mkdir -p ext/joltc/libs
        cp -r combined-libs/* ext/joltc/libs/
        
        echo ""
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "ğŸ“¦ Staging library changes..."
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        git add -v ext/joltc/libs/
        
        echo ""
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "ğŸ” Checking staged changes..."
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        git diff --cached --stat
        
        # Check if there are any changes to commit
        if git diff --cached --quiet; then
          echo ""
          echo "âš ï¸  No changes to joltc libraries detected"
          exit 0
        fi
        
        echo ""
        echo "âœ“ Changes detected, preparing commit..."
        echo ""
        
        # Create commit message with details
        echo "Auto-update joltc libraries [skip ci]" > commit_msg.txt
        echo "" >> commit_msg.txt
        echo "Built from commit: ${{ github.sha }}" >> commit_msg.txt
        echo "Workflow run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}" >> commit_msg.txt
        echo "" >> commit_msg.txt
        echo "Updated libraries:" >> commit_msg.txt
        
        # List what was updated
        git diff --cached --name-only | while read file; do
          echo "  - $file" >> commit_msg.txt
        done
        
        git commit -F commit_msg.txt
        
        # Pull any changes that happened during workflow execution
        echo ""
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "ğŸ”„ Pulling latest changes from remote..."
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        git pull --rebase origin main
        
        echo ""
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "â¬†ï¸  Pushing changes..."
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        git push origin main
        
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "âœ… JoltC libraries committed and pushed successfully"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
