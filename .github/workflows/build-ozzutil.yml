name: Build OzzUtil Libraries


on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:  # Allow manual triggering

# Required permissions for private repositories
permissions:
  contents: write  # Allow workflow to push commits back to repository

jobs:
  # Check if ozzutil source files have changed
  check-changes:
    name: Check for ozzutil source changes
    runs-on: ubuntu-latest
    outputs:
      should_build: ${{ steps.check_sources.outputs.changed }}
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 2
    
    - name: Check for source changes
      id: check_sources
      run: |
        SHOULD_BUILD=false
        
        # Check if this is a manual workflow dispatch - ALWAYS BUILD
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          echo "ğŸ”¨ Manual workflow dispatch - FORCING BUILD"
          SHOULD_BUILD=true
        # Check if this is the first commit
        elif ! git rev-parse HEAD~1 >/dev/null 2>&1; then
          echo "First commit - building all libraries"
          SHOULD_BUILD=true
        else
          # Get changed files
          CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD)
          
          # Check if ozzutil source files changed
          while IFS= read -r file; do
            if [[ "$file" == ext/ozzutil/src/* ]] || \
               [[ "$file" == ext/ozzutil/include/* ]] || \
               [[ "$file" == ext/ozzutil/CMakeLists.txt ]] || \
               [[ "$file" == ext/ozzutil/scripts/* ]] || \
               [[ "$file" == ext/ozzutil/*.c ]] || \
               [[ "$file" == ext/ozzutil/*.cc ]] || \
               [[ "$file" == .github/workflows/build-ozzutil.yml ]]; then
              echo "Found ozzutil source change: $file"
              SHOULD_BUILD=true
              break
            fi
          done <<< "$CHANGED_FILES"
        fi
        
        if [ "$SHOULD_BUILD" = true ]; then
          echo "changed=true" >> $GITHUB_OUTPUT
          echo "âœ“ Will build ozzutil libraries"
        else
          echo "changed=false" >> $GITHUB_OUTPUT
          echo "âœ“ No source changes affecting ozzutil libraries - skipping build"
        fi

  build-windows:
    name: Build Windows (x64)
    runs-on: windows-latest
    needs: check-changes
    if: needs.check-changes.outputs.should_build == 'true'
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: Build Release
      shell: pwsh
      run: |
        cd ext/ozzutil/scripts
        .\build-ozzutil-windows.ps1 -BuildType Release
    
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: windows-x64
        path: ext/ozzutil/libs/windows/**/*
        retention-days: 30

  build-macos:
    name: Build macOS (${{ matrix.arch }})
    runs-on: macos-latest
    needs: check-changes
    if: needs.check-changes.outputs.should_build == 'true'
    strategy:
      matrix:
        arch: [arm64, x86_64]
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: Build Release
      run: |
        cd ext/ozzutil/scripts
        chmod +x build-ozzutil-macos.sh
        ./build-ozzutil-macos.sh ${{ matrix.arch }} Release
    
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: macos-${{ matrix.arch }}
        path: ext/ozzutil/libs/macos/${{ matrix.arch == 'x86_64' && 'X64' || matrix.arch }}/**/*
        retention-days: 30

  build-linux:
    name: Build Linux (X64)
    runs-on: ubuntu-22.04
    needs: check-changes
    if: needs.check-changes.outputs.should_build == 'true'
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential cmake
    
    - name: Build Release
      run: |
        cd ext/ozzutil/scripts
        chmod +x build-ozzutil-linux.sh
        ./build-ozzutil-linux.sh X64 Release
    
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: linux-X64
        path: ext/ozzutil/libs/linux/**/*
        retention-days: 30

  build-web:
    name: Build Web (Emscripten)
    runs-on: ubuntu-latest
    needs: check-changes
    if: needs.check-changes.outputs.should_build == 'true'
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: Setup Emscripten
      uses: mymindstorm/setup-emsdk@v14
      with:
        version: '3.1.34'
    
    - name: Build Release
      run: |
        cd ext/ozzutil/scripts
        chmod +x build-ozzutil-web.sh
        ./build-ozzutil-web.sh Release
    
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: emscripten-wasm32
        path: ext/ozzutil/libs/emscripten/**/*
        retention-days: 30

  build-android:
    name: Build Android (${{ matrix.abi }})
    runs-on: ubuntu-latest
    needs: check-changes
    if: needs.check-changes.outputs.should_build == 'true'
    strategy:
      matrix:
        abi: [arm64-v8a, armeabi-v7a, x86_64]
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: Setup Android SDK
      uses: android-actions/setup-android@v3
    
    - name: Install Android NDK
      run: |
        echo "Installing Android NDK..."
        sdkmanager --install "ndk;27.2.12479018"
        echo "ANDROID_NDK_HOME=$ANDROID_SDK_ROOT/ndk/27.2.12479018" >> $GITHUB_ENV
        echo "ANDROID_NDK_ROOT=$ANDROID_SDK_ROOT/ndk/27.2.12479018" >> $GITHUB_ENV
    
    - name: Build Release
      run: |
        cd ext/ozzutil/scripts
        chmod +x build-ozzutil-android.sh
        ./build-ozzutil-android.sh ${{ matrix.abi }} Release
    
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: android-${{ matrix.abi }}
        path: ext/ozzutil/libs/android/${{ matrix.abi }}/**/*
        retention-days: 30

  build-ios:
    name: Build iOS (arm64)
    runs-on: macos-latest
    needs: check-changes
    if: needs.check-changes.outputs.should_build == 'true'
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: Build Release
      run: |
        cd ext/ozzutil/scripts
        chmod +x build-ozzutil-ios.sh
        ./build-ozzutil-ios.sh arm64 Release
    
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ios-arm64
        path: ext/ozzutil/libs/ios/**/*
        retention-days: 30

  # Combine all artifacts
  combine-artifacts:
    name: Combine All OzzUtil Libraries
    needs: [check-changes, build-windows, build-macos, build-linux, build-web, build-android, build-ios]
    runs-on: ubuntu-latest
    if: |
      always() &&
      needs.check-changes.outputs.should_build == 'true' &&
      (needs.build-windows.result == 'success' || needs.build-windows.result == 'skipped') &&
      (needs.build-macos.result == 'success' || needs.build-macos.result == 'skipped') &&
      (needs.build-linux.result == 'success' || needs.build-linux.result == 'skipped') &&
      (needs.build-web.result == 'success' || needs.build-web.result == 'skipped') &&
      (needs.build-android.result == 'success' || needs.build-android.result == 'skipped') &&
      (needs.build-ios.result == 'success' || needs.build-ios.result == 'skipped')
    
    steps:
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: libs
    
    - name: Reorganize artifacts
      run: |
        # Create final structure in ozzutil/libs/ directory
        mkdir -p combined-libs/ozzutil/libs/windows/x64/release
        mkdir -p combined-libs/ozzutil/libs/macos/arm64/release
        mkdir -p combined-libs/ozzutil/libs/macos/X64/release
        mkdir -p combined-libs/ozzutil/libs/linux/X64/release
        mkdir -p combined-libs/ozzutil/libs/emscripten/wasm32/release
        mkdir -p combined-libs/ozzutil/libs/android/arm64-v8a/release
        mkdir -p combined-libs/ozzutil/libs/android/armeabi-v7a/release
        mkdir -p combined-libs/ozzutil/libs/android/x86_64/release
        mkdir -p combined-libs/ozzutil/libs/ios/release
        
        # Copy Windows artifacts
        if [ -d "libs/windows-x64" ]; then
          cp -r libs/windows-x64/* combined-libs/ozzutil/libs/windows/ || true
        fi
        
        # Copy macOS artifacts
        if [ -d "libs/macos-arm64" ]; then
          cp -r libs/macos-arm64/* combined-libs/ozzutil/libs/macos/arm64/ || true
        fi
        if [ -d "libs/macos-x86_64" ]; then
          cp -r libs/macos-x86_64/* combined-libs/ozzutil/libs/macos/X64/ || true
        fi
        
        # Copy Linux artifacts
        if [ -d "libs/linux-X64" ]; then
          cp -r libs/linux-X64/* combined-libs/ozzutil/libs/linux/ || true
        fi
        
        # Copy Web artifacts
        if [ -d "libs/emscripten-wasm32" ]; then
          cp -r libs/emscripten-wasm32/* combined-libs/ozzutil/libs/emscripten/ || true
        fi
        
        # Copy Android artifacts
        if [ -d "libs/android-arm64-v8a" ]; then
          cp -r libs/android-arm64-v8a/* combined-libs/ozzutil/libs/android/arm64-v8a/ || true
        fi
        if [ -d "libs/android-armeabi-v7a" ]; then
          cp -r libs/android-armeabi-v7a/* combined-libs/ozzutil/libs/android/armeabi-v7a/ || true
        fi
        if [ -d "libs/android-x86_64" ]; then
          cp -r libs/android-x86_64/* combined-libs/ozzutil/libs/android/x86_64/ || true
        fi
        
        # Copy iOS artifacts
        if [ -d "libs/ios-arm64" ]; then
          cp -r libs/ios-arm64/* combined-libs/ozzutil/libs/ios/ || true
        fi
        
        # Show final structure
        echo "Final artifact structure:"
        find combined-libs -type f
    
    - name: Upload combined artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ozzutil-libraries-all-platforms
        path: combined-libs/**/*
        retention-days: 90
    
    - name: Commit libraries to repository
      if: github.ref == 'refs/heads/main' && github.event_name == 'push'
      run: |
        # Checkout the repository
        git clone https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git repo
        cd repo
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        
        # Copy new ozzutil libraries to ext/ozzutil/libs directory
        rm -rf ext/ozzutil/libs
        cp -r ../combined-libs/ozzutil/libs ext/ozzutil/
        
        # Check if there are any changes
        if git diff --quiet ext/ozzutil/libs/; then
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "No ozzutil library changes to commit"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          exit 0
        fi
        
        # Stage and commit changes
        git add ext/ozzutil/libs/
        
        # Create commit message and commit
        git commit -m "Auto-update built ozzutil libraries [skip ci]" \
                   -m "Generated from commit: ${{ github.sha }}" \
                   -m "Workflow run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
        
        # Pull with rebase in case there were other commits
        git pull --rebase origin main
        
        # Push changes
        git push origin main
        
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "âœ“ Successfully committed ozzutil libraries"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
